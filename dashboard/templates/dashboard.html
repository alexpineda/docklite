{% extends "base.html" %}
{% block content %}

{% if error_message %}
<div class="alert alert-danger">{{ error_message }}</div>
{% endif %}

<div class="container mt-4">
    <div class="card mb-4">
        <div class="card-body">
            <h2 class="card-title">Server Management</h2>
            <p class="text-muted">Manage server infrastructure including Docker, Caddy, and system dependencies.</p>
            <div class="btn-group">
                <button type="button" class="btn btn-primary" onclick="redeployServer()" {% if not docker_available %}disabled{% endif %}>
                    Full Server Redeploy
                </button>
                <button type="button" class="btn btn-secondary" onclick="deployAllServices()" {% if not docker_available %}disabled{% endif %}>
                    Deploy All Services
                </button>
            </div>
            <div class="mt-2">
                <small class="text-muted d-block">
                    <strong>Full Server Redeploy:</strong> ⚠️ Updates infrastructure (Docker, Caddy) and all services. Use with caution.
                </small>
                <small class="text-muted d-block">
                    <strong>Deploy All Services:</strong> Only redeploys API services without modifying infrastructure.
                </small>
            </div>
        </div>
    </div>

    <h2>API Services</h2>
    
    {% if services %}
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Domain</th>
                    <th>Image</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for service in services %}
                <tr class="{% if service.image_mismatch %}table-warning{% endif %}">
                    <td>
                        {{ service.name }}
                        {% if service.image_mismatch %}
                        <span class="badge bg-warning" data-bs-toggle="tooltip" data-bs-placement="right" title="Container is running an older version. Click 'Redeploy' to update.">!</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="https://{{ service.domain }}" target="_blank">{{ service.domain }}</a>
                    </td>
                    <td>{{ service.image }}</td>
                    <td>
                        <span class="badge {% if service.running %}bg-success{% else %}bg-danger{% endif %}">
                            {{ service.status }}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group">
                            <form action="{{ url_for('restart_service', name=service.name) }}" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-warning btn-sm" {% if not service.deployed %}disabled{% endif %}>Restart</button>
                            </form>
                            <form action="{{ url_for('shutdown_service', name=service.name) }}" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-danger btn-sm" {% if not service.deployed %}disabled{% endif %}>Shutdown Container</button>
                            </form>
                            <button type="button" class="btn btn-info btn-sm" onclick="deployService('{{ service.name }}')" {% if not docker_available %}disabled{% endif %}>
                                {% if service.deployed %}Redeploy{% else %}Deploy{% endif %}
                            </button>
                            {% if service.status in ['running'] %}
                            <button type="button" class="btn btn-primary btn-sm" onclick="showMetrics('{{ service.name }}')" data-bs-toggle="modal" data-bs-target="#metricsModal">
                                Metrics
                            </button>

                            {% endif %}
                            <button type="button" class="btn btn-secondary btn-sm" onclick="showLogs('{{ service.name }}')" data-bs-toggle="modal" data-bs-target="#logsModal">
                                Logs
                            </button>
                            <form action="{{ url_for('delete_service', name=service.name) }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this service? This action cannot be undone.')">
                                <button type="submit" class="btn btn-danger btn-sm" {% if not service.deployed %}disabled{% endif %}>Delete Container</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% if service.logs %}
                <tr>
                    <td colspan="5">
                        <pre class="logs">{{ service.logs|join('\n') }}</pre>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <p>No services found.</p>
    {% endif %}

    {% if orphaned_containers %}
    <h3 class="mt-4">Orphaned Containers</h3>
    <div class="alert alert-warning">
        These containers are running but have no corresponding service configuration.
    </div>
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Image</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for container in orphaned_containers %}
                <tr>
                    <td>{{ container.name }}</td>
                    <td>{{ container.image }}</td>
                    <td>
                        <span class="badge {% if container.running %}bg-success{% else %}bg-danger{% endif %}">
                            {{ container.status }}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group">
                            <form action="{{ url_for('shutdown_service', name=container.name) }}" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-danger btn-sm">Shutdown Container</button>
                            </form>
                            <form action="{{ url_for('delete_service', name=container.name) }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this container? This action cannot be undone.')">
                                <button type="submit" class="btn btn-danger btn-sm">Delete Container</button>
                            </form>
                            {% if container.status == 'running' %}
                            <button type="button" class="btn btn-primary btn-sm" onclick="showMetrics('{{ container.name }}')" data-bs-toggle="modal" data-bs-target="#metricsModal">
                                Metrics
                            </button>
                            {% endif %}
                            <button type="button" class="btn btn-secondary btn-sm" onclick="showLogs('{{ container.name }}')" data-bs-toggle="modal" data-bs-target="#logsModal">
                                Logs
                            </button>
                        </div>
                    </td>
                </tr>
                {% if container.logs %}
                <tr>
                    <td colspan="4">
                        <pre class="logs">{{ container.logs|join('\n') }}</pre>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<!-- Metrics Modal -->
<div class="modal fade" id="metricsModal" tabindex="-1" aria-labelledby="metricsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="metricsModalLabel">Container Metrics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <div class="row mb-3">
                        <div class="col">
                            <h6>CPU Usage</h6>
                            <div class="progress">
                                <div id="cpuBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small id="cpuText" class="text-muted">Loading...</small>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <h6>Memory Usage</h6>
                            <div class="progress">
                                <div id="memoryBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small id="memoryText" class="text-muted">Loading...</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <h6>Uptime</h6>
                            <p id="uptimeText" class="mb-0">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Logs Modal -->
<div class="modal fade" id="logsModal" tabindex="-1" aria-labelledby="logsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logsModalLabel">Container Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <div class="row mb-3">
                        <div class="col">
                            <h6>Container Status</h6>
                            <p id="containerStatus" class="mb-3">Loading...</p>
                            <h6>Recent Logs</h6>
                            <pre id="containerLogs" class="bg-dark text-light p-3" style="max-height: 400px; overflow-y: auto;">Loading...</pre>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="refreshLogs()">Refresh</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
});

function deployService(name) {
    window.location.href = `/stream-deploy-service?name=${name}`;
}

function redeployServer() {
    if (confirm('Are you sure you want to perform a full server redeploy? This will update all infrastructure components.')) {
        window.location.href = '/stream-deploy';
    }
}

function deployAllServices() {
    if (confirm('Are you sure you want to redeploy all API services?')) {
        window.location.href = '/stream-deploy-services';
    }
}

let metricsInterval;
let currentContainer;

function showMetrics(containerName) {
    console.log('showMetrics called for container:', containerName);
    
    // Create a Bootstrap modal instance
    const modalElement = document.getElementById('metricsModal');
    const modal = new bootstrap.Modal(modalElement);
    
    // Clear any existing interval
    if (metricsInterval) {
        clearInterval(metricsInterval);
    }
    
    currentContainer = containerName;
    
    // Show the modal
    modal.show();
    
    // Update metrics immediately
    updateMetrics();
    
    // Update metrics every 10 seconds
    metricsInterval = setInterval(updateMetrics, 10000);
    
    // Clear interval when modal is closed
    modalElement.addEventListener('hidden.bs.modal', function () {
        console.log('Modal closed, clearing interval');
        if (metricsInterval) {
            clearInterval(metricsInterval);
        }
    });
}

function updateMetrics() {
    fetch(`/container-stats/${currentContainer}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error(data.error);
                return;
            }
            
            // Update CPU
            const cpuBar = document.getElementById('cpuBar');
            const cpuText = document.getElementById('cpuText');
            cpuBar.style.width = `${Math.min(data.cpu_percent, 100)}%`;
            cpuText.textContent = `${data.cpu_percent}% CPU`;
            
            // Update Memory
            const memoryBar = document.getElementById('memoryBar');
            const memoryText = document.getElementById('memoryText');
            memoryBar.style.width = `${data.memory_percent}%`;
            memoryText.textContent = `${data.memory_usage} MB / ${data.memory_limit} MB (${data.memory_percent}%)`;
            
            // Update Uptime
            const uptimeText = document.getElementById('uptimeText');
            uptimeText.textContent = data.uptime_human;
        })
        .catch(error => {
            console.error('Error fetching metrics:', error);
        });
}

let currentLogsContainer;

function showLogs(containerName) {
    currentLogsContainer = containerName;
    updateLogs();
}

function updateLogs() {
    fetch(`/container-logs/${currentLogsContainer}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('containerStatus').textContent = data.status;
            document.getElementById('containerLogs').textContent = data.logs;
        })
        .catch(error => {
            console.error('Error fetching logs:', error);
            document.getElementById('containerStatus').textContent = 'Error fetching status';
            document.getElementById('containerLogs').textContent = 'Error fetching logs';
        });
}

function refreshLogs() {
    updateLogs();
}
</script>

{% endblock %} 