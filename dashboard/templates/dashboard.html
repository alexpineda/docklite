{% extends "base.html" %}
{% block content %}

{% if error_message %}
<div class="alert alert-danger">{{ error_message }}</div>
{% endif %}

<div class="container mt-4">
    <h2>API Services</h2>
    
    {% if services %}
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Domain</th>
                    <th>Image</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for service in services %}
                <tr class="{% if service.image_mismatch %}table-warning{% endif %}">
                    <td>{{ service.name }}</td>
                    <td>
                        <a href="https://{{ service.domain }}" target="_blank">{{ service.domain }}</a>
                        {% if service.image_mismatch %}
                        <span class="badge bg-warning" title="Container image differs from configuration">!</span>
                        {% endif %}
                    </td>
                    <td>{{ service.image }}</td>
                    <td>
                        <span class="badge {% if service.running %}bg-success{% else %}bg-danger{% endif %}">
                            {{ service.status }}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group">
                            <form action="{{ url_for('restart_service', name=service.name) }}" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-warning btn-sm" {% if not service.deployed %}disabled{% endif %}>Restart</button>
                            </form>
                            <form action="{{ url_for('shutdown_service', name=service.name) }}" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-danger btn-sm" {% if not service.deployed %}disabled{% endif %}>Shutdown</button>
                            </form>
                            <button type="button" class="btn btn-info btn-sm" onclick="deployService('{{ service.name }}')" {% if not docker_available %}disabled{% endif %}>
                                {% if service.deployed %}Redeploy{% else %}Deploy{% endif %}
                            </button>
                        </div>
                    </td>
                </tr>
                {% if service.logs %}
                <tr>
                    <td colspan="5">
                        <pre class="logs">{{ service.logs|join('\n') }}</pre>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>No services configured yet.</p>
    {% endif %}

    {% if orphaned_containers %}
    <h3 class="mt-4">Orphaned Containers</h3>
    <div class="alert alert-warning">
        These containers are running but have no corresponding service configuration.
    </div>
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Image</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for container in orphaned_containers %}
                <tr>
                    <td>{{ container.name }}</td>
                    <td>{{ container.image }}</td>
                    <td>
                        <span class="badge {% if container.running %}bg-success{% else %}bg-danger{% endif %}">
                            {{ container.status }}
                        </span>
                    </td>
                    <td>
                        <form action="{{ url_for('shutdown_service', name=container.name) }}" method="POST" style="display: inline;">
                            <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                        </form>
                    </td>
                </tr>
                {% if container.logs %}
                <tr>
                    <td colspan="4">
                        <pre class="logs">{{ container.logs|join('\n') }}</pre>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <div class="mt-4">
        <h3>Add New Service</h3>
        <form action="{{ url_for('deploy') }}" method="POST">
            <div class="mb-3">
                <label for="image" class="form-label">Docker Image</label>
                <input type="text" class="form-control" id="image" name="image" required>
            </div>
            <div class="mb-3">
                <label for="domain" class="form-label">Domain</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="domain" name="domain" required>
                    <span class="input-group-text">.{{ base_domain }}</span>
                </div>
            </div>
            <button type="submit" class="btn btn-primary" {% if not docker_available %}disabled{% endif %}>Deploy</button>
        </form>
    </div>
</div>

<script>
function deployService(name) {
    window.location.href = `/stream-deploy-service?name=${name}`;
}
</script>

{% endblock %} 